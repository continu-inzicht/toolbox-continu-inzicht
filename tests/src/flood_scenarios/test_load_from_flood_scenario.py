import pandas as pd
import numpy as np
from toolbox_continu_inzicht.flood_scenarios import LoadFromFloodScenarioProbability

from pathlib import Path
from toolbox_continu_inzicht.base.config import Config
from toolbox_continu_inzicht.base.data_adapter import DataAdapter


def helper_create_data_adapter(name):
    """Create a DataAdapter object with the given config file name, reducing code duplication."""
    test_data_sets_path = Path(__file__).parent / "data_sets"
    config = Config(config_path=test_data_sets_path / name)
    config.lees_config()
    return DataAdapter(config=config)


def test_load_from_flood_scenario():
    """test of de minimal werkt"""
    data_adapter = helper_create_data_adapter("test_load_from_flood_scenario.yaml")
    load_from_flood_scenario_probability = LoadFromFloodScenarioProbability(
        data_adapter=data_adapter
    )
    load_from_flood_scenario_probability.run(
        input=[
            "segment_failure_probability",
            "breach_id_to_segment_id",
            "section_failure_probability_data",
        ],
        output="flood_scenario_load_resultaten",
    )
    # todo: segment to dikesystem
    df_out = load_from_flood_scenario_probability.df_out
    assert not df_out.empty
    assert "hydraulicload" in df_out.columns
    assert np.isclose(df_out["hydraulicload"].max(), 14.95)
    assert np.isclose(df_out["hydraulicload"].min(), 4.0)


from toolbox_continu_inzicht.utils.interpolate import (
    log_y_interpolate_1d,
)
import matplotlib.pyplot as plt


def test_interp_y_fc():
    df_fc = pd.DataFrame(
        {
            "hydraulicload": {
                0: 11.15,
                1: 11.25,
                2: 11.35,
                3: 11.45,
                4: 11.55,
                5: 11.65,
                6: 11.749999999999998,
                7: 11.849999999999998,
                8: 11.949999999999998,
                9: 12.049999999999995,
                10: 12.149999999999997,
                11: 12.249999999999996,
                12: 12.349999999999996,
                13: 12.449999999999996,
                14: 12.549999999999995,
                15: 12.649999999999997,
                16: 12.749999999999996,
                17: 12.849999999999994,
                18: 12.949999999999994,
                19: 13.049999999999994,
                20: 13.15,
                21: 13.2,
                22: 13.250000000000002,
                23: 13.300000000000002,
                24: 13.350000000000003,
                25: 13.400000000000004,
                26: 13.450000000000005,
                27: 13.500000000000004,
                28: 13.550000000000006,
                29: 13.600000000000009,
                30: 13.650000000000007,
                31: 13.700000000000008,
                32: 13.750000000000009,
                33: 13.80000000000001,
                34: 13.85000000000001,
                35: 13.900000000000013,
                36: 13.950000000000012,
                37: 14.000000000000012,
                38: 14.050000000000011,
                39: 14.100000000000014,
                40: 14.150000000000016,
                41: 14.200000000000015,
                42: 14.250000000000016,
                43: 14.300000000000017,
                44: 14.350000000000016,
                45: 14.400000000000018,
                46: 14.45000000000002,
                47: 14.50000000000002,
                48: 14.55000000000002,
                49: 14.60000000000002,
                50: 14.650000000000022,
                51: 14.700000000000022,
                52: 14.750000000000025,
                53: 14.800000000000024,
                54: 14.850000000000025,
                55: 14.900000000000023,
                56: 14.950000000000026,
                57: 15.000000000000028,
                58: 15.050000000000027,
                59: 15.100000000000028,
                60: 15.150000000000029,
                61: 15.20000000000003,
                62: 15.25000000000003,
                63: 15.300000000000033,
                64: 15.350000000000032,
                65: 15.400000000000032,
                66: 15.450000000000031,
                67: 15.500000000000034,
                68: 15.550000000000034,
                69: 15.600000000000035,
                70: 15.650000000000036,
                71: 15.700000000000037,
                72: 15.750000000000036,
                73: 15.800000000000038,
                74: 15.85000000000004,
                75: 15.90000000000004,
                76: 15.95000000000004,
                77: 16.000000000000043,
                78: 16.05000000000004,
                79: 16.100000000000044,
            },
            "failure_probability": {
                0: 0.0,
                1: 0.0,
                2: 4.636286154183976e-257,
                3: 1.766899395221747e-178,
                4: 1.5058609916918617e-126,
                5: 9.607639684078955e-102,
                6: 9.445745667721344e-85,
                7: 1.716731708683095e-71,
                8: 4.709704180833941e-61,
                9: 8.362037095865654e-53,
                10: 2.845431792128693e-46,
                11: 4.4116593400909417e-41,
                12: 6.4893611936608096e-37,
                13: 1.7036036006750642e-33,
                14: 1.3396658836559225e-30,
                15: 4.62607100692888e-28,
                16: 9.000604267721224e-26,
                17: 1.0466037129348652e-23,
                18: 1.0162014090675544e-21,
                19: 6.205303968919257e-20,
                20: 3.2719575306939218e-18,
                21: 2.0736781628715024e-17,
                22: 1.231376456259411e-16,
                23: 6.863357645795378e-16,
                24: 3.5971666861592136e-15,
                25: 1.7760854062543198e-14,
                26: 8.277135062511517e-14,
                27: 3.648573149085551e-13,
                28: 1.5241601405606944e-12,
                29: 6.047923321356271e-12,
                30: 2.2847997983577248e-11,
                31: 8.237760337284354e-11,
                32: 2.8409294524039067e-10,
                33: 9.394227854250372e-10,
                34: 2.985667648122629e-09,
                35: 9.139556266677636e-09,
                36: 2.7007608267377593e-08,
                37: 7.718966545408275e-08,
                38: 2.1379468460764305e-07,
                39: 5.747919890389261e-07,
                40: 1.502445355035609e-06,
                41: 3.823065845344918e-06,
                42: 9.48103581482638e-06,
                43: 2.293401127246688e-05,
                44: 5.414469756901849e-05,
                45: 0.0001247913535097,
                46: 0.0002807720585821,
                47: 0.0006164118934677,
                48: 0.0013194154873481,
                49: 0.0027488955939458,
                50: 0.0055688153020766,
                51: 0.0109487411480606,
                52: 0.0208397158163406,
                53: 0.0382823903739431,
                54: 0.0676103021109216,
                55: 0.1142678325864441,
                56: 0.1840245287078634,
                57: 0.2804022418068695,
                58: 0.4021687225204282,
                59: 0.5410540601007088,
                60: 0.6282357429947742,
                61: 0.649507535962996,
                62: 0.7081958067017611,
                63: 0.7780003521871629,
                64: 0.8365773363427355,
                65: 0.8811279093045458,
                66: 0.9138966530346448,
                67: 0.9376168281808726,
                68: 0.9546659126780932,
                69: 0.9668998442909174,
                70: 0.9756935133203783,
                71: 0.9820383127762798,
                72: 0.98663942617174,
                73: 0.9901011430986956,
                74: 0.9925401628636058,
                75: 0.994341413984042,
                76: 0.9956803442202594,
                77: 0.9966820590443952,
                78: 0.9974362541062566,
                79: 0.9980076141353106,
            },
        }
    )

    x, fp = df_fc["hydraulicload"].to_numpy(), df_fc["failure_probability"].to_numpy()
    y = np.array(sorted(list(fp) + [4.636286154183976e-257]))
    new_x = log_y_interpolate_1d(y, x, fp, ll=1e-200)

    plt.plot(x, fp, label="data points")
    plt.plot(new_x, y, label="interpolated")
    plt.yscale("log")
    plt.show()
    new_x


def test_interp_x_fc():
    df_fc = pd.DataFrame(
        {
            "hydraulicload": {
                -1: 10.0,
                0: 11.15,
                1: 11.25,
                2: 11.35,
                3: 11.45,
                4: 11.55,
                5: 11.65,
                6: 11.749999999999998,
                7: 11.849999999999998,
                8: 11.949999999999998,
                9: 12.049999999999995,
                10: 12.149999999999997,
                11: 12.249999999999996,
                12: 12.349999999999996,
                13: 12.449999999999996,
                14: 12.549999999999995,
                15: 12.649999999999997,
                16: 12.749999999999996,
                17: 12.849999999999994,
                18: 12.949999999999994,
                19: 13.049999999999994,
                20: 13.15,
                21: 13.2,
                22: 13.250000000000002,
                23: 13.300000000000002,
                24: 13.350000000000003,
                25: 13.400000000000004,
                26: 13.450000000000005,
                27: 13.500000000000004,
                28: 13.550000000000006,
                29: 13.600000000000009,
                30: 13.650000000000007,
                31: 13.700000000000008,
                32: 13.750000000000009,
                33: 13.80000000000001,
                34: 13.85000000000001,
                35: 13.900000000000013,
                36: 13.950000000000012,
                37: 14.000000000000012,
                38: 14.050000000000011,
                39: 14.100000000000014,
                40: 14.150000000000016,
                41: 14.200000000000015,
                42: 14.250000000000016,
                43: 14.300000000000017,
                44: 14.350000000000016,
                45: 14.400000000000018,
                46: 14.45000000000002,
                47: 14.50000000000002,
                48: 14.55000000000002,
                49: 14.60000000000002,
                50: 14.650000000000022,
                51: 14.700000000000022,
                52: 14.750000000000025,
                53: 14.800000000000024,
                54: 14.850000000000025,
                55: 14.900000000000023,
                56: 14.950000000000026,
                57: 15.000000000000028,
                58: 15.050000000000027,
                59: 15.100000000000028,
                60: 15.150000000000029,
                61: 15.20000000000003,
                62: 15.25000000000003,
                63: 15.300000000000033,
                64: 15.350000000000032,
                65: 15.400000000000032,
                66: 15.450000000000031,
                67: 15.500000000000034,
                68: 15.550000000000034,
                69: 15.600000000000035,
                70: 15.650000000000036,
                71: 15.700000000000037,
                72: 15.750000000000036,
                73: 15.800000000000038,
                74: 15.85000000000004,
                75: 15.90000000000004,
                76: 15.95000000000004,
                77: 16.000000000000043,
                78: 16.05000000000004,
                79: 16.100000000000044,
            },
            "failure_probability": {
                -1: 0.0,
                0: 0.0,
                1: 0.0,
                2: 4.636286154183976e-257,
                3: 1.766899395221747e-178,
                4: 1.5058609916918617e-126,
                5: 9.607639684078955e-102,
                6: 9.445745667721344e-85,
                7: 1.716731708683095e-71,
                8: 4.709704180833941e-61,
                9: 8.362037095865654e-53,
                10: 2.845431792128693e-46,
                11: 4.4116593400909417e-41,
                12: 6.4893611936608096e-37,
                13: 1.7036036006750642e-33,
                14: 1.3396658836559225e-30,
                15: 4.62607100692888e-28,
                16: 9.000604267721224e-26,
                17: 1.0466037129348652e-23,
                18: 1.0162014090675544e-21,
                19: 6.205303968919257e-20,
                20: 3.2719575306939218e-18,
                21: 2.0736781628715024e-17,
                22: 1.231376456259411e-16,
                23: 6.863357645795378e-16,
                24: 3.5971666861592136e-15,
                25: 1.7760854062543198e-14,
                26: 8.277135062511517e-14,
                27: 3.648573149085551e-13,
                28: 1.5241601405606944e-12,
                29: 6.047923321356271e-12,
                30: 2.2847997983577248e-11,
                31: 8.237760337284354e-11,
                32: 2.8409294524039067e-10,
                33: 9.394227854250372e-10,
                34: 2.985667648122629e-09,
                35: 9.139556266677636e-09,
                36: 2.7007608267377593e-08,
                37: 7.718966545408275e-08,
                38: 2.1379468460764305e-07,
                39: 5.747919890389261e-07,
                40: 1.502445355035609e-06,
                41: 3.823065845344918e-06,
                42: 9.48103581482638e-06,
                43: 2.293401127246688e-05,
                44: 5.414469756901849e-05,
                45: 0.0001247913535097,
                46: 0.0002807720585821,
                47: 0.0006164118934677,
                48: 0.0013194154873481,
                49: 0.0027488955939458,
                50: 0.0055688153020766,
                51: 0.0109487411480606,
                52: 0.0208397158163406,
                53: 0.0382823903739431,
                54: 0.0676103021109216,
                55: 0.1142678325864441,
                56: 0.1840245287078634,
                57: 0.2804022418068695,
                58: 0.4021687225204282,
                59: 0.5410540601007088,
                60: 0.6282357429947742,
                61: 0.649507535962996,
                62: 0.7081958067017611,
                63: 0.7780003521871629,
                64: 0.8365773363427355,
                65: 0.8811279093045458,
                66: 0.9138966530346448,
                67: 0.9376168281808726,
                68: 0.9546659126780932,
                69: 0.9668998442909174,
                70: 0.9756935133203783,
                71: 0.9820383127762798,
                72: 0.98663942617174,
                73: 0.9901011430986956,
                74: 0.9925401628636058,
                75: 0.994341413984042,
                76: 0.9956803442202594,
                77: 0.9966820590443952,
                78: 0.9974362541062566,
                79: 0.9980076141353106,
            },
        }
    )

    x, fp = df_fc["hydraulicload"].to_numpy(), df_fc["failure_probability"].to_numpy()
    y = np.array(sorted(list(fp) + [0.183]))
    new_x = log_y_interpolate_1d(y, x, fp, ll=1e-200)

    plt.plot(x, fp, label="data points")
    plt.plot(new_x, y, label="interpolated")
    plt.yscale("log")
    plt.show()
    new_x
